<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ET Water Market â€¢ Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-bg-color: #f0f0f0;
      --tg-text-color: #000;
      --tg-hint-color: #999;
      --tg-button-color: #5288c1;
      --tg-button-text-color: #fff;
      --accent: #2e7d32;
      --danger: #d32f2f;
    }

    body.dark {
      --tg-bg-color: #17212b;
      --tg-text-color: #f0f0f0;
      --tg-hint-color: #aaa;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--tg-bg-color);
      color: var(--tg-text-color);
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    header {
      background: var(--tg-button-color);
      color: var(--tg-button-text-color);
      padding: 14px 16px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    header h1 { font-size: 22px; margin: 0; }
    .moto { font-size: 14px; opacity: 0.9; }

    .top-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px 8px;
      background: var(--tg-bg-color);
      position: sticky;
      top: 56px;
      z-index: 9;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .search-bar {
      flex: 1;
      background: var(--tg-bg-color);
      border: 1px solid var(--tg-hint-color);
      border-radius: 12px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      min-width: 0;
    }
    .search-bar input {
      background: transparent;
      border: none;
      flex: 1;
      font-size: 16px;
      color: var(--tg-text-color);
      outline: none;
      min-width: 0;
    }

    .filter-wrapper {
      flex-shrink: 0;
    }
    .filter-wrapper select {
      background: var(--tg-bg-color);
      color: var(--tg-text-color);
      border: 1px solid var(--tg-hint-color);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      max-width: 160px;
      cursor: pointer;
    }

    .categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(88px, 1fr));
      gap: 12px;
      padding: 16px;
      background: var(--tg-bg-color);
    }

    .category-tile {
      background: var(--tg-bg-color);
      border-radius: 16px;
      padding: 12px 8px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.18s, box-shadow 0.18s;
    }
    .category-tile:active { transform: scale(0.94); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .category-tile img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 8px;
    }
    .category-tile span {
      font-size: 13px;
      display: block;
    }

    .brand-section {
      display: none;
      padding: 16px 16px 120px;
      background: var(--tg-bg-color);
      margin: 0;
    }
    .brand-section.active {
      display: block;
    }

    .brand-header {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 24px;
      color: var(--tg-button-color);
      text-align: center;
    }

    .variant {
      background: rgba(82,136,193,0.08);
      border: 1px solid rgba(82,136,193,0.2);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .variant-info { flex: 1; }
    .variant-size { font-size: 18px; font-weight: 600; }
    .variant-price { font-size: 22px; color: var(--accent); font-weight: bold; }

    .order-btn {
      background: var(--tg-button-color);
      color: var(--tg-button-text-color);
      border: none;
      border-radius: 12px;
      padding: 12px 28px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s, opacity 0.2s;
      min-width: 110px;
    }
    .order-btn:active {
      transform: scale(0.96);
      opacity: 0.92;
    }

    .nutrition {
      margin-top: 32px;
      padding: 20px;
      background: rgba(46,125,50,0.08);
      border-radius: 16px;
      border: 1px solid rgba(46,125,50,0.2);
    }
    .nutrition h3 {
      margin: 0 0 16px;
      color: var(--accent);
      font-size: 18px;
      text-align: center;
    }
    .nutrition-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }
    .nutrition-table td {
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    .nutrition-table td:first-child { font-weight: 500; }
    .nutrition-table td:last-child {
      text-align: right;
      color: var(--tg-button-color);
      font-weight: 600;
    }

    #cart-summary {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--tg-bg-color);
      border-top: 1px solid rgba(0,0,0,0.1);
      padding: 16px;
      box-shadow: 0 -6px 16px rgba(0,0,0,0.15);
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      z-index: 100;
    }
    #cart-summary.visible { transform: translateY(0); }

    .cart-close-btn {
      position: absolute;
      top: 12px;
      right: 16px;
      width: 36px;
      height: 36px;
      background: transparent;
      border: none;
      border-radius: 50%;
      font-size: 28px;
      font-weight: 300;
      color: var(--tg-text-color);
      opacity: 0.7;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
      z-index: 10;
      transition: all 0.18s ease;
    }

    .cart-close-btn:hover,
    .cart-close-btn:focus {
      opacity: 1;
      background: rgba(0,0,0,0.08);
    }

    body.dark .cart-close-btn:hover,
    body.dark .cart-close-btn:focus {
      background: rgba(255,255,255,0.12);
    }

    .cart-close-btn:active {
      transform: scale(0.92);
      opacity: 0.9;
    }

    #cart-items { list-style: none; margin: 12px 0 20px; max-height: 260px; overflow-y: auto; }
    .cart-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      font-size: 15px;
    }
    .cart-item-name { flex: 1; font-weight: 500; }
    .cart-qty-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0 16px;
    }
    .qty-btn {
      width: 38px;
      height: 38px;
      border: none;
      border-radius: 50%;
      font-size: 22px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .qty-minus { background: rgba(211,47,47,0.12); color: var(--danger); }
    .qty-plus  { background: rgba(46,125,50,0.12); color: var(--accent); }

    #total {
      font-weight: bold;
      text-align: right;
      font-size: 20px;
      margin: 12px 0 16px;
      padding-top: 12px;
      border-top: 2px solid rgba(0,0,0,0.08);
    }

    #empty { text-align: center; color: var(--tg-hint-color); padding: 48px 0; font-size: 16px; }

    #no-results {
      display: none;
      text-align: center;
      padding: 40px 20px;
      color: var(--tg-hint-color);
      font-size: 16px;
      background: var(--tg-bg-color);
      margin: 0 16px 16px;
      border-radius: 16px;
    }

    .footer {
      text-align: center;
      padding: 24px 16px;
      color: var(--tg-hint-color);
      font-size: 14px;
      background: rgba(0,0,0,0.03);
      border-top: 1px solid rgba(0,0,0,0.08);
    }

    @media (min-width: 500px) {
      body { max-width: 480px; margin: 0 auto; }
    }
  </style>
</head>
<body>

  <header>
    <h1 id="header-title">ET Water Market (+350 Agents)</h1>
    <div class="moto">To your need â€¢ Addis Ababa delivery</div>
  </header>

  <div class="top-controls">
    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="Search brands" />
    </div>
    <div class="filter-wrapper">
      <select id="sortFilter">
        <option value="default">Filter by</option>
        <option value="price-low-high">Price:Low </option>
      </select>
    </div>
  </div>

  <div class="categories" id="categories"></div>

  <div id="no-results">No brands found</div>

  <!-- Cart â€“ no count badge anymore -->
  <div id="cart-summary">
    <button id="close-cart-btn" class="cart-close-btn">Ã—</button>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h2 style="margin:0; font-size:20px;">Your Cart</h2>
      <!-- cart count badge removed -->
    </div>
    <ul id="cart-items"></ul>
    <div id="total">Total: 0 Birr</div>
    <div id="empty">Cart is empty â€“ pick your water! ðŸ’§</div>
  </div>

  <div class="footer">
    Contact for requests / delivery in Addis Ababa<br>
    <strong style="color:var(--tg-button-color); font-size:16px;">0984748168</strong>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    tg.MainButton.setParams({
      text: 'Checkout',
      color: tg.themeParams.button_color || '#00b140',
      text_color: tg.themeParams.button_text_color || '#ffffff'
    });
    tg.MainButton.hide();

    // Theme synchronization
    function applyTheme() {
      const isDark = tg.colorScheme === 'dark';
      document.body.classList.toggle('dark', isDark);

      const params = tg.themeParams;
      document.documentElement.style.setProperty('--tg-bg-color', params.bg_color || (isDark ? '#17212b' : '#f0f0f0'));
      document.documentElement.style.setProperty('--tg-text-color', params.text_color || (isDark ? '#f0f0f0' : '#000'));
      document.documentElement.style.setProperty('--tg-hint-color', params.hint_color || (isDark ? '#aaa' : '#999'));
      document.documentElement.style.setProperty('--tg-button-color', params.button_color || '#5288c1');
      document.documentElement.style.setProperty('--tg-button-text-color', params.button_text_color || '#fff');

      tg.MainButton.setParams({
        color: params.button_color,
        text_color: params.button_text_color
      });
    }
    applyTheme();
    tg.onEvent('themeChanged', applyTheme);

    // Brands data (shortened for readability â€“ add your full list back if needed)
    const brands = [
      { id: 'aquaddis', name: 'Aquaddis', img: 'https://i.postimg.cc/dVD0gdmt/aquaddis.webp', brandDisplay: 'Aquaddis/ Agents',
        variants: [{size:'0.3L', price:140}, {size:'0.6L', price:150}, {size:'2L', price:160}],
        nutrition: [{label:'Calcium', val:'0.4 mg/L'}, {label:'Magnesium', val:'1.3 mg/L'}, {label:'Sodium', val:'2.3 mg/L'}, {label:'TDS', val:'20 mg/L'}]
      },
      // ... add the rest of your brands here ...
      { id: 'eden', name: 'Eden water', img: 'https://i.postimg.cc/xCnkHL01/eden.webp', brandDisplay: 'Eden Water/ Agents',
        variants: [{size:'0.3L', price:140}, {size:'0.6L', price:150}, {size:'2L', price:160}],
        nutrition: [{label:'Calcium', val:'0.4 mg/L'},{label:'Magnesium', val:'1.3 mg/L'},{label:'Sodium', val:'2.3 mg/L'},{label:'TDS', val:'20 mg/L'}]
      }
    ];

    // Generate UI dynamically
    const categoriesEl = document.getElementById('categories');

    brands.forEach(brand => {
      const minPrice = Math.min(...brand.variants.map(v => v.price));

      const tile = document.createElement('div');
      tile.className = 'category-tile';
      tile.setAttribute('data-brand-id', brand.id);
      tile.setAttribute('data-min-price', minPrice);
      tile.innerHTML = `
        <img src="${brand.img}" alt="${brand.name}" loading="lazy">
        <span>${brand.name}</span>
      `;
      tile.addEventListener('click', () => showBrand(brand.id));
      categoriesEl.appendChild(tile);

      const section = document.createElement('div');
      section.id = `${brand.id}-section`;
      section.className = 'brand-section';

      let variantsHTML = '';
      brand.variants.forEach(v => {
        variantsHTML += `
          <div class="variant">
            <div class="variant-info">
              <div class="variant-size">${v.size}/Pack</div>
              <div class="variant-price">${v.price} Birr</div>
            </div>
            <button class="order-btn" data-brand="${brand.brandDisplay}" data-size="${v.size}" data-price="${v.price}">Order</button>
          </div>`;
      });

      let nutritionHTML = '';
      if (brand.nutrition?.length) {
        nutritionHTML = `
          <div class="nutrition">
            <h3>Nutrition Facts (per liter)</h3>
            <table class="nutrition-table">
              ${brand.nutrition.map(n => `<tr><td>${n.label}</td><td>${n.val}</td></tr>`).join('')}
            </table>
          </div>`;
      }

      section.innerHTML = `
        <div class="brand-header">${brand.brandDisplay}</div>
        ${variantsHTML}
        ${nutritionHTML}
      `;

      document.body.appendChild(section);
    });

    // Cart logic
    let cart = [];

    function loadCart() {
      tg.CloudStorage.getItem('cart', (err, saved) => {
        if (!err && saved) {
          try { cart = JSON.parse(saved); } catch(e) {}
        }
        renderCart();
      });
    }

    function saveCart() {
      tg.CloudStorage.setItem('cart', JSON.stringify(cart));
    }

    function addToCart(brand, size, price) {
      const key = `${brand}|${size}`;
      const existing = cart.find(i => `${i.brand}|${i.size}` === key);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({ brand, size, price, qty: 1 });
      }
      renderCart();
      saveCart();
      tg.HapticFeedback.impactOccurred('medium');
    }

    function changeQty(index, delta) {
      cart[index].qty += delta;
      if (cart[index].qty <= 0) cart.splice(index, 1);
      renderCart();
      saveCart();
      tg.HapticFeedback.impactOccurred('light');
    }

    function renderCart() {
      const list = document.getElementById('cart-items');
      const totalEl = document.getElementById('total');
      const emptyEl = document.getElementById('empty');
      const summary = document.getElementById('cart-summary');

      list.innerHTML = '';
      let total = 0;

      if (cart.length === 0) {
        emptyEl.style.display = 'block';
        totalEl.textContent = 'Total: 0 Birr';
        summary.classList.remove('visible');
        tg.MainButton.hide();
        tg.BackButton.hide();
        return;
      }

      emptyEl.style.display = 'none';
      summary.classList.add('visible');
      tg.BackButton.show();

      cart.forEach((item, i) => {
        const line = item.price * item.qty;
        total += line;

        const li = document.createElement('li');
        li.className = 'cart-item';
        li.innerHTML = `
          <div class="cart-item-name">${item.brand} ${item.size}</div>
          <div class="cart-qty-controls">
            <button class="qty-btn qty-minus" data-index="${i}" data-delta="-1">âˆ’</button>
            <span class="qty-display">${item.qty}</span>
            <button class="qty-btn qty-plus" data-index="${i}" data-delta="1">+</button>
          </div>
          <div class="cart-item-total">${line} Birr</div>
        `;
        list.appendChild(li);
      });

      totalEl.textContent = `Total: ${total} Birr`;
      tg.MainButton.setText(`Checkout â€¢ ${total} Birr`);
      tg.MainButton.show();
    }

    // Navigation functions (unchanged)
    function showBrand(id) {
      document.querySelector('.top-controls').style.display = 'none';
      document.querySelector('.categories').style.display = 'none';
      document.getElementById('no-results').style.display = 'none';

      document.querySelectorAll('.brand-section').forEach(el => el.classList.remove('active'));
      const section = document.getElementById(`${id}-section`);
      if (section) section.classList.add('active');

      tg.BackButton.show();
      tg.HapticFeedback.impactOccurred('light');
      window.scrollTo({ top: 0, behavior: 'instant' });
    }

    function returnToMainView() {
      document.querySelectorAll('.brand-section').forEach(el => el.classList.remove('active'));

      document.querySelector('.top-controls').style.display = 'flex';
      document.querySelector('.categories').style.display = 'grid';
      document.getElementById('no-results').style.display = 'none';

      if (!document.getElementById('cart-summary').classList.contains('visible')) {
        tg.BackButton.hide();
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
      tg.HapticFeedback.impactOccurred('light');
    }

    tg.BackButton.onClick(() => {
      const brandIsVisible = !!document.querySelector('.brand-section.active');
      const cartIsVisible  = document.getElementById('cart-summary').classList.contains('visible');

      if (brandIsVisible) {
        returnToMainView();
      }
      else if (cartIsVisible) {
        document.getElementById('cart-summary').classList.remove('visible');
        tg.BackButton.hide();
      }

      tg.HapticFeedback.impactOccurred('light');
    });

    // Event delegation
    document.addEventListener('click', e => {
      const t = e.target;

      if (t.classList.contains('order-btn')) {
        const { brand, size, price } = t.dataset;
        addToCart(brand, size, Number(price));
      }

      if (t.classList.contains('qty-minus') || t.classList.contains('qty-plus')) {
        const index = Number(t.dataset.index);
        const delta = Number(t.dataset.delta);
        if (!isNaN(index)) changeQty(index, delta);
      }

      if (t.id === 'close-cart-btn') {
        document.getElementById('cart-summary').classList.remove('visible');
        tg.BackButton.hide();
        tg.HapticFeedback.impactOccurred('light');
      }
    });

    // Sort filter (unchanged)
    document.getElementById('sortFilter').addEventListener('change', e => {
      const value = e.target.value;
      const tiles = Array.from(document.querySelectorAll('.category-tile'));
      const container = document.getElementById('categories');

      if (value === 'price-low-high') {
        tiles.sort((a, b) => {
          const pA = parseInt(a.getAttribute('data-min-price') || '9999', 10);
          const pB = parseInt(b.getAttribute('data-min-price') || '9999', 10);
          return pA - pB;
        });
        tiles.forEach(tile => container.appendChild(tile));
      } else {
        brands.forEach(brand => {
          const tile = document.querySelector(`[data-brand-id="${brand.id}"]`);
          if (tile) container.appendChild(tile);
        });
      }
    });

    // Search (unchanged)
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', e => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const q = e.target.value.toLowerCase().trim();
        const tiles = document.querySelectorAll('.category-tile');
        let visible = 0;

        tiles.forEach(tile => {
          const name = tile.querySelector('span').textContent.toLowerCase();
          const show = name.includes(q) || ['140','150','160'].some(p => q.includes(p));
          tile.style.display = show ? '' : 'none';
          if (show) visible++;
        });

        document.getElementById('no-results').style.display =
          (q && visible === 0) ? 'block' : 'none';
      }, 280);
    });

    // Init
    loadCart();
    tg.MainButton.onClick(() => {
      if (!cart.length) return;

      const phone = prompt("ðŸ“ž Phone number for delivery (Addis Ababa)\nExample: 0912345678", "");
      if (!phone || phone.trim().length < 9) {
        tg.showAlert("Please enter a valid phone number.");
        return;
      }

      let msg = `New Order â€“ ET Water\nPhone: ${phone.trim()}\nDelivery: Addis Ababa\n\nItems:\n`;
      let sum = 0;
      cart.forEach(i => {
        const lt = i.price * i.qty;
        msg += `â€¢ ${i.brand} ${i.size} Ã— ${i.qty} = ${lt} Birr\n`;
        sum += lt;
      });
      msg += `\nTotal: ${sum} Birr`;

      if (!confirm(msg + "\n\nConfirm order?")) return;

      tg.showAlert("âœ… Order placed! We will contact you soon.\nThank you! ðŸ’§");
      cart = [];
      renderCart();
      saveCart();
    });

  </script>
</body>
</html>