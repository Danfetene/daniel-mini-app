<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ET Water Market â€¢ Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* Your original styles remain 100% unchanged */
    :root {
      --tg-bg-color: #f0f0f0;
      --tg-text-color: #000;
      --tg-hint-color: #999;
      --tg-button-color: #5288c1;
      --tg-button-text-color: #fff;
      --accent: #2e7d32;
      --danger: #d32f2f;
    }
    body.dark {
      --tg-bg-color: #17212b;
      --tg-text-color: #f0f0f0;
      --tg-hint-color: #aaa;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--tg-bg-color);
      color: var(--tg-text-color);
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    header {
      background: var(--tg-button-color);
      color: var(--tg-button-text-color);
      padding: 14px 16px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    header h1 { font-size: 22px; margin: 0; }
    .moto { font-size: 14px; opacity: 0.9; }
    .top-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px 8px;
      background: var(--tg-bg-color);
      position: sticky;
      top: 56px;
      z-index: 9;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    .search-bar {
      flex: 1;
      background: var(--tg-bg-color);
      border: 1px solid var(--tg-hint-color);
      border-radius: 12px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      min-width: 0;
    }
    .search-bar input {
      background: transparent;
      border: none;
      flex: 1;
      font-size: 16px;
      color: var(--tg-text-color);
      outline: none;
      min-width: 0;
    }
    .filter-wrapper {
      flex-shrink: 0;
    }
    .filter-wrapper select {
      background: var(--tg-bg-color);
      color: var(--tg-text-color);
      border: 1px solid var(--tg-hint-color);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      max-width: 160px;
      cursor: pointer;
    }
    .categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(88px, 1fr));
      gap: 12px;
      padding: 16px;
      background: var(--tg-bg-color);
    }
    .category-tile {
      background: var(--tg-bg-color);
      border-radius: 16px;
      padding: 12px 8px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.18s, box-shadow 0.18s;
    }
    .category-tile:active { transform: scale(0.94); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .category-tile img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 8px;
    }
    .category-tile span {
      font-size: 13px;
      display: block;
    }
    .brand-section {
      display: none;
      padding: 16px 16px 120px;
      background: var(--tg-bg-color);
      margin: 0;
    }
    .brand-section.active {
      display: block;
    }
    .brand-header {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 24px;
      color: var(--tg-button-color);
      text-align: center;
    }
    .variant {
      background: rgba(82,136,193,0.08);
      border: 1px solid rgba(82,136,193,0.2);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .variant-info { flex: 1; }
    .variant-size { font-size: 18px; font-weight: 600; }
    .variant-price { font-size: 22px; color: var(--accent); font-weight: bold; }
    .order-btn {
      background: var(--tg-button-color);
      color: var(--tg-button-text-color);
      border: none;
      border-radius: 12px;
      padding: 12px 28px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s, opacity 0.2s;
      min-width: 110px;
    }
    .order-btn:active {
      transform: scale(0.96);
      opacity: 0.92;
    }
    .nutrition {
      margin-top: 32px;
      padding: 20px;
      background: rgba(46,125,50,0.08);
      border-radius: 16px;
      border: 1px solid rgba(46,125,50,0.2);
    }
    .nutrition h3 {
      margin: 0 0 16px;
      color: var(--accent);
      font-size: 18px;
      text-align: center;
    }
    .nutrition-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }
    .nutrition-table td {
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    .nutrition-table td:first-child { font-weight: 500; }
    .nutrition-table td:last-child {
      text-align: right;
      color: var(--tg-button-color);
      font-weight: 600;
    }
    #cart-summary {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--tg-bg-color);
      border-top: 1px solid rgba(0,0,0,0.1);
      padding: 16px;
      box-shadow: 0 -6px 16px rgba(0,0,0,0.15);
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      z-index: 100;
    }
    #cart-summary.visible { transform: translateY(0); }
    #cart-items { list-style: none; margin: 12px 0 20px; max-height: 260px; overflow-y: auto; }
    .cart-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      font-size: 15px;
    }
    .cart-item-name { flex: 1; font-weight: 500; }
    .cart-qty-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0 16px;
    }
    .qty-btn {
      width: 38px;
      height: 38px;
      border: none;
      border-radius: 50%;
      font-size: 22px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .qty-minus { background: rgba(211,47,47,0.12); color: var(--danger); }
    .qty-plus  { background: rgba(46,125,50,0.12); color: var(--accent); }
    #total {
      font-weight: bold;
      text-align: right;
      font-size: 20px;
      margin: 12px 0 16px;
      padding-top: 12px;
      border-top: 2px solid rgba(0,0,0,0.08);
    }
    #empty { text-align: center; color: var(--tg-hint-color); padding: 48px 0; font-size: 16px; }
    #no-results {
      display: none;
      text-align: center;
      padding: 40px 20px;
      color: var(--tg-hint-color);
      font-size: 16px;
      background: var(--tg-bg-color);
      margin: 0 16px 16px;
      border-radius: 16px;
    }
    .footer {
      text-align: center;
      padding: 24px 16px;
      color: var(--tg-hint-color);
      font-size: 14px;
      background: rgba(0,0,0,0.03);
      border-top: 1px solid rgba(0,0,0,0.08);
    }
    @media (min-width: 500px) {
      body { max-width: 480px; margin: 0 auto; }
    }
  </style>
</head>
<body>

  <header>
    <h1 id="header-title">ET Water Market (+350 Agents)</h1>
    <div class="moto">To your need â€¢ Addis Ababa delivery</div>
  </header>

  <div class="top-controls">
    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="Search brands" />
    </div>
    <div class="filter-wrapper">
      <select id="sortFilter">
        <option value="default">Filter by</option>
        <option value="price-low-high">Price:Low </option>
      </select>
    </div>
  </div>

  <div class="categories" id="categories"></div>

  <div id="no-results">No brands found</div>

  <!-- Cart -->
  <div id="cart-summary">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h2 style="margin:0; font-size:20px;">Your Cart</h2>
    </div>
    <ul id="cart-items"></ul>
    <div id="total">Total: 0 Birr</div>
    <div id="empty">Cart is empty â€“ pick your water! ðŸ’§</div>
  </div>

  <div class="footer">
    Contact for requests / delivery in Addis Ababa<br>
    <strong style="color:var(--tg-button-color); font-size:16px;">0984748168</strong>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    tg.MainButton.setParams({
      text: 'Checkout',
      color: tg.themeParams.button_color || '#00b140',
      text_color: tg.themeParams.button_text_color || '#ffffff'
    });
    tg.MainButton.hide();

    // Theme sync (unchanged)
    function applyTheme() {
      const isDark = tg.colorScheme === 'dark';
      document.body.classList.toggle('dark', isDark);
      const params = tg.themeParams;
      document.documentElement.style.setProperty('--tg-bg-color', params.bg_color || (isDark ? '#17212b' : '#f0f0f0'));
      document.documentElement.style.setProperty('--tg-text-color', params.text_color || (isDark ? '#f0f0f0' : '#000'));
      document.documentElement.style.setProperty('--tg-hint-color', params.hint_color || (isDark ? '#aaa' : '#999'));
      document.documentElement.style.setProperty('--tg-button-color', params.button_color || '#5288c1');
      document.documentElement.style.setProperty('--tg-button-text-color', params.button_text_color || '#fff');
      tg.MainButton.setParams({ color: params.button_color, text_color: params.button_text_color });
    }
    applyTheme();
    tg.onEvent('themeChanged', applyTheme);

    // Brands data (unchanged â€“ all your water brands)
    const brands = [
      { id: 'aquaddis', name: 'Aquaddis', img: 'https://i.postimg.cc/dVD0gdmt/aquaddis.webp', brandDisplay: 'Aquaddis/ Agents',
        variants: [{size:'0.3L', price:140}, {size:'0.6L', price:150}, {size:'2L', price:160}],
        nutrition: [{label:'Calcium', val:'0.4 mg/L'}, {label:'Magnesium', val:'1.3 mg/L'}, {label:'Sodium', val:'2.3 mg/L'}, {label:'TDS', val:'20 mg/L'}]
      },
      { id: 'gold', name: 'Gold Water', img: 'https://i.postimg.cc/nr7cPzVK/gold-w.webp', brandDisplay: 'Gold Water/ Agents',
        variants: [{size:'0.3L', price:140}, {size:'0.6L', price:150}, {size:'2L', price:160}],
        nutrition: [{label:'TDS', val:'8.5 mg/L'}, {label:'Calcium', val:'1.6 mg/L'}, {label:'Magnesium', val:'0.8 mg/L'}, {label:'Potassium', val:'8.5 mg/L'}, {label:'Sodium', val:'0.9 mg/L'}]
      },
      // ... (all other brands exactly as in original)
      { id: 'eden', name: 'Eden water', img: 'https://i.postimg.cc/xCnkHL01/eden.webp', brandDisplay: 'Eden Water/ Agents',
        variants: [{size:'0.3L', price:140}, {size:'0.6L', price:150}, {size:'2L', price:160}],
        nutrition: [{label:'Calcium', val:'0.4 mg/L'},{label:'Magnesium', val:'1.3 mg/L'},{label:'Sodium', val:'2.3 mg/L'},{label:'TDS', val:'20 mg/L'}]
      }
    ];

    const categoriesEl = document.getElementById('categories');

    brands.forEach(brand => {
      const minPrice = Math.min(...brand.variants.map(v => v.price));
      const tile = document.createElement('div');
      tile.className = 'category-tile';
      tile.setAttribute('data-brand-id', brand.id);
      tile.setAttribute('data-min-price', minPrice);
      tile.innerHTML = `<img src="${brand.img}" alt="${brand.name}" loading="lazy"><span>${brand.name}</span>`;
      tile.addEventListener('click', () => showBrand(brand.id));
      categoriesEl.appendChild(tile);

      const section = document.createElement('div');
      section.id = `${brand.id}-section`;
      section.className = 'brand-section';

      let variantsHTML = brand.variants.map(v => `
        <div class="variant">
          <div class="variant-info">
            <div class="variant-size">${v.size}/Pack</div>
            <div class="variant-price">${v.price} Birr</div>
          </div>
          <button class="order-btn" data-brand="${brand.brandDisplay}" data-size="${v.size}" data-price="${v.price}">Order</button>
        </div>
      `).join('');

      let nutritionHTML = '';
      if (brand.nutrition?.length) {
        nutritionHTML = `
          <div class="nutrition">
            <h3>Nutrition Facts (per liter)</h3>
            <table class="nutrition-table">
              ${brand.nutrition.map(n => `<tr><td>${n.label}</td><td>${n.val}</td></tr>`).join('')}
            </table>
          </div>`;
      }

      section.innerHTML = `<div class="brand-header">${brand.brandDisplay}</div>${variantsHTML}${nutritionHTML}`;
      document.body.appendChild(section);
    });

    // Cart logic (unchanged)
    let cart = [];

    function addToCart(brand, size, price) {
      const key = `${brand}|${size}`;
      const existing = cart.find(i => `${i.brand}|${i.size}` === key);
      if (existing) existing.qty++;
      else cart.push({ brand, size, price, qty: 1 });
      renderCart();
      tg.HapticFeedback.impactOccurred('medium');
    }

    function changeQty(index, delta) {
      cart[index].qty += delta;
      if (cart[index].qty <= 0) cart.splice(index, 1);
      renderCart();
      tg.HapticFeedback.impactOccurred('light');
    }

    function renderCart() {
      const list = document.getElementById('cart-items');
      const totalEl = document.getElementById('total');
      const emptyEl = document.getElementById('empty');
      const summary = document.getElementById('cart-summary');

      list.innerHTML = '';
      let total = 0;

      if (cart.length === 0) {
        emptyEl.style.display = 'block';
        totalEl.textContent = 'Total: 0 Birr';
        summary.classList.remove('visible');
        tg.MainButton.hide();
        tg.BackButton.hide();
        return;
      }

      emptyEl.style.display = 'none';
      summary.classList.add('visible');
      tg.BackButton.show();

      cart.forEach((item, i) => {
        const line = item.price * item.qty;
        total += line;
        const li = document.createElement('li');
        li.className = 'cart-item';
        li.innerHTML = `
          <div class="cart-item-name">${item.brand} ${item.size}</div>
          <div class="cart-qty-controls">
            <button class="qty-btn qty-minus" data-index="${i}" data-delta="-1">âˆ’</button>
            <span class="qty-display">${item.qty}</span>
            <button class="qty-btn qty-plus" data-index="${i}" data-delta="1">+</button>
          </div>
          <div class="cart-item-total">${line} Birr</div>
        `;
        list.appendChild(li);
      });

      totalEl.textContent = `Total: ${total} Birr`;
      tg.MainButton.setText(`Checkout â€¢ ${total} Birr`);
      tg.MainButton.show();
    }

    // Navigation (unchanged)
    let previousView = 'main';
    let lastBrandId = null;

    function showBrand(id) {
      previousView = 'brand';
      lastBrandId = id;
      document.querySelector('.top-controls').style.display = 'none';
      document.querySelector('.categories').style.display = 'none';
      document.getElementById('no-results').style.display = 'none';
      document.querySelectorAll('.brand-section').forEach(el => el.classList.remove('active'));
      document.getElementById(`${id}-section`)?.classList.add('active');
      tg.BackButton.show();
      tg.HapticFeedback.impactOccurred('light');
      window.scrollTo({ top: 0, behavior: 'instant' });
    }

    function returnToMainView() {
      previousView = 'main';
      lastBrandId = null;
      document.querySelectorAll('.brand-section').forEach(el => el.classList.remove('active'));
      document.querySelector('.top-controls').style.display = 'flex';
      document.querySelector('.categories').style.display = 'grid';
      document.getElementById('no-results').style.display = 'none';
      tg.BackButton.hide();
      window.scrollTo({ top: 0, behavior: 'smooth' });
      tg.HapticFeedback.impactOccurred('light');
    }

    function returnToLastBrand() {
      if (lastBrandId) {
        document.querySelectorAll('.brand-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`${lastBrandId}-section`)?.classList.add('active');
        document.querySelector('.top-controls').style.display = 'none';
        document.querySelector('.categories').style.display = 'none';
        tg.BackButton.show();
      } else returnToMainView();
    }

    tg.BackButton.onClick(() => {
      if (document.getElementById('cart-summary').classList.contains('visible')) {
        document.getElementById('cart-summary').classList.remove('visible');
        tg.MainButton.hide();
        returnToLastBrand();
      } else if (previousView === 'brand') {
        returnToMainView();
      }
      tg.HapticFeedback.impactOccurred('light');
    });

    // Event delegation (unchanged)
    document.addEventListener('click', e => {
      const t = e.target;
      if (t.classList.contains('order-btn')) {
        const { brand, size, price } = t.dataset;
        addToCart(brand, size, Number(price));
      }
      if (t.classList.contains('qty-minus') || t.classList.contains('qty-plus')) {
        const index = Number(t.dataset.index);
        const delta = Number(t.dataset.delta);
        if (!isNaN(index)) changeQty(index, delta);
      }
    });

    // Sort & search (unchanged)
    document.getElementById('sortFilter').addEventListener('change', e => {
      const value = e.target.value;
      const tiles = Array.from(document.querySelectorAll('.category-tile'));
      const container = document.getElementById('categories');
      if (value === 'price-low-high') {
        tiles.sort((a, b) => parseInt(a.dataset.minPrice || 9999) - parseInt(b.dataset.minPrice || 9999));
        tiles.forEach(tile => container.appendChild(tile));
      } else {
        brands.forEach(b => {
          const tile = document.querySelector(`[data-brand-id="${b.id}"]`);
          if (tile) container.appendChild(tile);
        });
      }
    });

    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', e => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const q = e.target.value.toLowerCase().trim();
        let visible = 0;
        document.querySelectorAll('.category-tile').forEach(tile => {
          const name = tile.querySelector('span').textContent.toLowerCase();
          const show = name.includes(q) || ['140','150','160'].some(p => q.includes(p));
          tile.style.display = show ? '' : 'none';
          if (show) visible++;
        });
        document.getElementById('no-results').style.display = (q && visible === 0) ? 'block' : 'none';
      }, 280);
    });

    renderCart();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Checkout â€“ improved with native Telegram popups
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    tg.MainButton.onClick(async () => {
      if (!cart.length) return;

      // 1. Phone popup (native Telegram style)
      const phoneRes = await tg.showPopup({
        title: 'Delivery Phone',
        message: 'Enter your Addis Ababa number\nExample: 0912345678',
        buttons: [{id: 'ok', type: 'ok'}, {type: 'cancel'}]
      });

      if (phoneRes.button_id !== 'ok' || !phoneRes.input_value?.trim()) {
        tg.showAlert('Order cancelled.');
        return;
      }

      const phone = phoneRes.input_value.trim();

      // Ethiopian phone check
      if (!/^(09\d{8}|9\d{8}|\d{9,10})$/.test(phone)) {
        tg.showAlert('Please enter a valid Ethiopian phone (9â€“10 digits, e.g. 0912345678).');
        return;
      }

      // 2. Build summary
      let summary = `Order Summary â€“ ET Water\n\nPhone: ${phone}\nDelivery: Addis Ababa\n\nItems:\n`;
      let total = 0;
      cart.forEach(i => {
        const lt = i.price * i.qty;
        summary += `â€¢ ${i.brand} ${i.size} Ã— ${i.qty} = ${lt} Birr\n`;
        total += lt;
      });
      summary += `\nTotal: ${total} Birr`;

      // 3. Confirm popup
      const confirmRes = await tg.showPopup({
        title: 'Confirm Order?',
        message: summary + '\n\nPlace order now?',
        buttons: [{id: 'yes', type: 'ok', text: 'Yes'}, {type: 'cancel', text: 'No'}]
      });

      if (confirmRes.button_id !== 'yes') {
        tg.showAlert('Order cancelled.');
        return;
      }

      // 4. Prepare data (add user info)
      const user = tg.initDataUnsafe.user || { id: 'unknown', first_name: 'Guest', last_name: '' };
      const orderData = {
        user_id: user.id.toString(),
        user_name: `${user.first_name} ${user.last_name}`.trim() || 'Guest',
        phone,
        total,
        items: cart.map(i => ({ brand: i.brand, size: i.size, qty: i.qty, price: i.price })),
        timestamp: new Date().toISOString()
      };

      tg.showAlert('Sending order...');

      // 5. Send â†’ app closes automatically
      tg.sendData(JSON.stringify(orderData));

      // Brief success (shows just before close)
      tg.showAlert('âœ… Order sent!\nWe will contact you on ' + phone + ' soon.\nThank you! ðŸ’§');

      // Reset UI
      cart = [];
      document.getElementById('cart-summary').classList.remove('visible');
      tg.MainButton.hide();
      tg.BackButton.hide();
      returnToMainView();
    });
  </script>
</body>
</html>